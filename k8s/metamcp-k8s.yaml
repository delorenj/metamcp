# Kubernetes manifests for the metamcp application
# This file has been updated with your environment configuration.
#
# Before you apply this, please:
# 1. Make sure you have a Kubernetes cluster and `kubectl` is configured.
# 2. Make sure you have a running Traefik Ingress Controller that can provision
#    a LoadBalancer service and that you have a cert-manager installed.
# 3. Verify the `POSTGRES_HOST` in the `ConfigMap` is resolvable from your pods.

apiVersion: v1
kind: Namespace
metadata:
  name: metamcp
---
# =============================================================================
# CONFIGURATION & SECRETS
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: metamcp-secret
  namespace: metamcp
type: Opaque
stringData:
  # These values have been taken from your .env file.
  POSTGRES_USER: "postgres"
  POSTGRES_PASSWORD: "postgres"
  BETTER_AUTH_SECRET: "95f815281b98c36acdb205414d6f9babec8acef5e2d4feeda5ec5b80043d0f7e"
  # OIDC secrets would go here if you were using them
  OIDC_CLIENT_ID: ""
  OIDC_CLIENT_SECRET: ""
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metamcp-config
  namespace: metamcp
data:
  # --- Application Configuration ---
  NODE_ENV: "production"

  # IMPORTANT: Verify this hostname is correct for your K8s environment.
  # It should be the service name of your PostgreSQL database.
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "metamcp"
  DATABASE_URL: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"

  # Application URLs
  APP_URL: "https://mcp.delo.sh"
  NEXT_PUBLIC_APP_URL: "https://mcp.delo.sh"

  # Optional OIDC
  OIDC_DISCOVERY_URL: ""

  # Node settings
  NODE_OPTIONS: "--max-old-space-size=2048"
  UV_THREADPOOL_SIZE: "4"

  # This is likely not needed in Kubernetes but is preserved for consistency.
  TRANSFORM_LOCALHOST_TO_DOCKER_INTERNAL: "true"
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: metamcp-scripts
  namespace: metamcp
data:
  # Scripts from your ./scripts directory are included here.
  # Note: These scripts seem tailored for a Docker/systemd environment and may not be
  # directly usable in Kubernetes without modification.
  fix-mcp-permissions.sh: |
    #!/bin/bash
    # Fix MCP Server Permissions Script
    # This script resolves permission issues with MCP servers that need to create log directories
    set -e
    echo "üîß Fixing MCP server permissions..."
    # Create logs directory in the metamcp project
    METAMCP_DIR="/home/delorenj/code/utils/metamcp"
    LOGS_DIR="$METAMCP_DIR/logs"
    if [ ! -d "$LOGS_DIR" ]; then
        echo "üìÅ Creating logs directory: $LOGS_DIR"
        mkdir -p "$LOGS_DIR"
    fi
    # Set proper permissions
    chmod 755 "$LOGS_DIR"
    echo "‚úÖ Set permissions for logs directory"
    # Create a temporary directory for MCP servers if needed
    TEMP_MCP_DIR="/tmp/mcp-servers"
    if [ ! -d "$TEMP_MCP_DIR" ]; then
        echo "üìÅ Creating temporary MCP directory: $TEMP_MCP_DIR"
        mkdir -p "$TEMP_MCP_DIR"
        chmod 755 "$TEMP_MCP_DIR"
    fi
    # Create logs subdirectory in temp
    TEMP_LOGS_DIR="$TEMP_MCP_DIR/logs"
    if [ ! -d "$TEMP_LOGS_DIR" ]; then
        echo "üìÅ Creating temporary logs directory: $TEMP_LOGS_DIR"
        mkdir -p "$TEMP_LOGS_DIR"
        chmod 755 "$TEMP_LOGS_DIR"
    fi
    echo "‚úÖ MCP server permissions fixed!"
    echo "üìç Logs directory: $LOGS_DIR"
    echo "üìç Temp MCP directory: $TEMP_MCP_DIR"
    echo ""
    echo "üí° If you're still experiencing issues:"
    echo "   1. Restart Claude Desktop"
    echo "   2. Check that the delonet-tools MCP server is configured correctly"
    echo "   3. Verify the API key is valid"
    echo ""
    echo "üîç To monitor MCP server logs:"
    echo "   tail -f $LOGS_DIR/*.log"
  install-systemd-service.sh: |
    #!/bin/bash
    # Install MetaMCP as a systemd service
    # Run this script with sudo: sudo ./install-systemd-service.sh
    set -e
    # Colors for output
    RED=''
																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																																							1.0